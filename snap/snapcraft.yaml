name: audacity
adopt-info: audacity
description: |
  AudacityÂ® is a free, easy-to-use, multi-track audio editor and recorder for Windows,
  Mac OS X, GNU/Linux and other operating systems. The interface is translated into
  many languages.

  You can use Audacity to:
  * Record live audio
  * Convert tapes and records into digital recordings or CDs
  * Edit WAV, AIFF, FLAC, MP2, MP3 or Ogg Vorbis sound files
  * Cut, copy, splice or mix sounds together
  * Change the speed or pitch of a recording
  * Apply a wide range of other effects to audio recordings

grade: stable
confinement: strict

architectures:
- build-on: amd64
- build-on: i386

apps:
  audacity:
    command: desktop-launch alsa-launch $SNAP/usr/bin/audacity
    desktop: usr/share/applications/audacity.desktop
    plugs:
    - desktop
    - desktop-legacy
    - home
    - pulseaudio
    - removable-media
    - wayland
    - x11

parts:
  # specify remote part build order
  alsa:
    after: [alsa-lib, alsa-plugins]
  alsa-lib:
    # configflags needed until LP#1766878 is fixed
    configflags:
    - --prefix=/usr
    - --sysconfdir=/etc
    - --libexec=/usr/lib
    - --libdir=/usr/lib
    - --localstatedir=/var
    - --with-configdir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/share/alsa
    - --with-plugindir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/lib/alsa-lib
    - --disable-alisp
    - --disable-aload
    - --disable-python
    - --disable-rawmidi
    - --disable-static
    - --disable-topology
    - --disable-ucm
    - --enable-symbolic-functions
  alsa-plugins:
    after: [alsa-lib]
    # configflags needed until LP#1766878 is fixed
    configflags:
    - --prefix=/usr
    - --sysconfdir=/etc
    - --libexec=/usr/lib
    - --libdir=/usr/lib
    - --localstatedir=/var
    - --disable-arcamav
    - --disable-avcodec
    - --disable-jack
    - --disable-mix
    - --disable-oss
    - --disable-usbstream
    - --with-plugindir=/snap/$SNAPCRAFT_PROJECT_NAME/current/usr/lib/alsa-lib
    - --disable-static
    - LDFLAGS=-L$SNAPCRAFT_STAGE/usr/lib

  ffmpeg:
    after: [alsa]
    plugin: autotools
    source: https://github.com/FFmpeg/FFmpeg.git
    source-tag: n4.1
    build-packages:
      - libass-dev
      - libbz2-dev
      - libcrystalhd-dev
      - libdrm-dev
      - libfdk-aac-dev
      - liblzma-dev
      - libmp3lame-dev
      - libogg-dev
      - libomxil-bellagio-dev
      - libopus-dev
      - libsctp-dev
      - libspeex-dev
      - libtheora-dev
      - libtwolame-dev
      - libvorbis-dev
      - libx11-dev
      - libxcb-shape0-dev
      - libxcb-shm0-dev
      - libxcb-xfixes0-dev
      - nasm
      - pkg-config
      - yasm
      - zlib1g-dev
    stage-packages:
      - libass5
      - libcrystalhd3
      - libfdk-aac0
      - libmp3lame0
      - libogg0
      - libopus0
      - libspeex1
      - libtheora0
      - libtwolame0
      - libx11-6
      - libxau6
      - libxcb-shape0
      - libxcb-shm0
      - libxcb-xfixes0
      - libxcb1
      - libxdmcp6
      - libxext6
      - zlib1g
    configflags:
      - --prefix=/usr
      - --disable-debug
      - --disable-doc
      - --disable-static
      - --enable-avisynth
      - --enable-ffplay
      - --enable-gpl
      - --enable-libass
      - --enable-libfdk-aac
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libmp3lame
      - --enable-libopus
      - --enable-libpulse
      - --enable-libspeex
      - --enable-libtheora
      - --enable-libtwolame
      - --enable-libvorbis
      - --enable-libxcb
      - --enable-nonfree
      - --enable-omx
      - --enable-runtime-cpudetect
      - --enable-shared
      - --enable-version3
    prime:
      - usr/bin
      - usr/lib
      - -usr/lib/pkgconfig
      - -usr/include
      - -usr/share/doc
      - -usr/share/man

  audacity:
    after: [desktop-gtk2, alsa, ffmpeg]
    plugin: autotools
    source: https://github.com/audacity/audacity.git
    parse-info: [usr/share/appdata/audacity.appdata.xml]
    override-pull: |
      snapcraftctl pull
      last_committed_tag="$(git describe --tags --abbrev=0)"
      last_released_tag="$(snap info $SNAPCRAFT_PROJECT_NAME | awk '$1 == "beta:" { print $2 }')"
      # If the latest tag from the upstream project has not been released to
      # beta, build that tag instead of master.
      if [ "${last_committed_tag}" != "${last_released_tag}" ]; then
        git fetch
        git checkout "${last_committed_tag}"
        snapcraftctl set-version "$(echo "${last_committed_tag}" | sed -E -e "s|^$SNAPCRAFT_PROJECT_NAME-?||i")"
      else
        snapcraftctl set-version "$(git rev-parse --short HEAD)"
      fi
      sed -i 's|Icon=.*|Icon=${SNAP}/usr/share/icons/hicolor/scalable/apps/audacity.svg|' src/audacity.desktop.in
    configflags:
    - --prefix=/usr
    - --with-expat
    - --with-ffmpeg
    - --with-lame
    - --with-libflac
    - --with-libid3tag
    - --with-libmad
    - --with-libsbsms
    - --with-libsndfile
    - --with-soundtouch
    - --with-libsoxr
    - --with-twolame
    - --with-libvamp
    - --with-libvorbis
    - --with-lv2
    - --with-portaudio
    - --with-midi
    - --with-portmidi
    - --with-widgetextra=local
    - --with-portmixer
    build-packages:
    - gettext
    - libexpat1-dev
    - libflac-dev
    - libflac++-dev
    - libgtk2.0-dev
    - libid3tag0-dev
    - liblv2dynparam1-dev
    - libmad0-dev
    - libmp3lame-dev
    - libportmidi-dev
    - libportsmf-dev
    - libpulse-dev
    - libsbsms-dev
    - libsndfile1-dev
    - libsoundtouch-dev
    - libsoxr-dev
    - libtwolame-dev
    - libvamp-hostsdk3v5
    - libvamp-sdk2v5
    - libvorbis-dev
    - libwxbase3.0-dev
    - libwxgtk3.0-dev
    - python
    - vamp-plugin-sdk
    stage-packages:
    - libexpat1
    - libflac8
    - libflac++6v5
    - libgtk2.0-0
    - libid3tag0
    - liblv2dynparamhost1-1
    - libmad0
    - libmp3lame0
    - libportmidi0
    - libportsmf0v5
    - libpulse0
    - libsbsms10
    - libsndfile1
    - libsoundtouch1
    - libsoxr0
    - libtwolame0
    - libvamp-hostsdk3v5
    - libvamp-sdk2v5
    - libvorbis0a
    - libvorbisfile3
    - libwxbase3.0-0v5
    - libwxgtk3.0-0v5
    stage:
    - -usr/share/alsa
